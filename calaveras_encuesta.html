<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Encuesta de Satisfacción</title>

        <style>
            div{
                margin-bottom: 2vw;
            }
            #successDiv{
                border: double 1px #000;
            }
        </style>
    </head>
    <body>
        <form id="myPoll">
            <div>
                <label for="media">1.- ¿Cómo supiste de nustra página?</label> <br>
                <input type="checkbox" name="media" value="internet">Por internet <br>
                <input type="checkbox" name="media" value="periodico">Por periódico <br>
                <input type="checkbox" name="media" value="radio">Por radio <br>
                <input type="checkbox" name="media" value="redes">Por las redes sociales <br>
            </div>

            <div>
                <label for="success">2.- ¿Encontraste lo que buscabas?</label> <br>
                <input type="radio" name="success" value="si"> Si <br>
                <input type="radio" name="success" value="no"> No <br>
            </div>

            <div>
                <label for="contents">3.- ¿Qué contenidos preferirías encontrar en esta página?</label> <br>
                <input type="checkbox" name="contents" value="ferias">a) Ferias y Festivales en sedes en la ciudad de México y el resto del país <br>   
                <input type="checkbox" name="contents" value="juegos">b) Juegos y actividades en línea <br>
                <input type="checkbox" name="contents" value="info actividades">c) Información sobre las actividades de la Coordinación Nacional de Desarrollo Cultural Infantil – Alas y Raíces <br>
                <input type="checkbox" name="contents" value="info padres">d) Información para padres de familia sobre crianza y derechos de los niños <br>
                <input type="checkbox" name="contents" value="info capacitacion">e) Información sobre capacitación para promoción cultural <br>
            </div>

            <div>
                <label for="age">4.- ¿Qué edad tienes?</label> <br>
                <input type="radio" name="age" value="6-12">a) Entre 6 y 12 años <br>
                <input type="radio" name="age" value="13-17">b) Entre 13 y 17 años <br>
                <input type="radio" name="age" value="18-29">c) Entre 18 y 29 años <br>
                <input type="radio" name="age" value="30-39">d) De 30 a 39 años <br>
                <input type="radio" name="age" value="40-49">e) De 40 a 49 años <br>
                <input type="radio" name="age" value="50-59">f) De 50 a 59 años <br>            
                <input type="radio" name="age" value="60">g) 60 años en adelante <br>            
            </div>

            <div>
                <label for="childs">5.- Si eres padre o madre de familia, ¿Cuántos hijos tienes?</label> <br>
                <input type="radio" name="childs" value="1">a) Uno <br>
                <input type="radio" name="childs" value="2">b) Dos <br>
                <input type="radio" name="childs" value="3">c) Tres <br>
                <input type="radio" name="childs" value="4+">d) Más de tres <br>
            </div>

            <div>
                <label for="childAge">6.- ¿Qué edades tienen tus hijos?</label> <br>
                <input type="radio" name="childAge" value="0-6">a) Entre 0 a 6 años <br>
                <input type="radio" name="childAge" value="6-12">b) Entre 6 a 12 años <br>
                <input type="radio" name="childAge" value="14-17">c) Entre 13 a 17 años <br>
            </div>

            <div>
                <label for="device">7.- ¿Cómo ingresaste a nuestra página?</label> <br>
                <input type="radio" name="device" value="celular">a) Por medio de mi celular <br>
                <input type="radio" name="device" value="tablet">b) Por medio de una tablet <br>
                <input type="radio" name="device" value="computadora">c) Por medio de una computadora <br>
            </div>

            <div>
                <label for="register">8.- ¿Quieres recibir información sobre las actividades, carteleras, programación de ferias y festivales de Alas y Raíces?</label> <br>
                <input type="radio" name="register" value="si">a) Si <br>
                <div id="mailDiv" style="display:none"><label for="mail">Proporcionanos tu correo electrónico </label> <input type="mail" name="mail"> <br></div>
                <input type="radio" name="register" value="no">b) No <br><br>
            </div>

            <div>
                <button type="button" id="submitBtn">Enviar</button>
            </div>

            <div id="successDiv"></div>
        </form>
    </body>

    <script>
        const form = document.getElementById('myPoll');
        const submitBtn = document.getElementById('submitBtn');

        const registerRadio = document.getElementsByName("register");
        const mailDiv = document.getElementById('mailDiv');
        const successDiv = document.getElementById('successDiv');
        
        const postUrl = 'http://localhost/ayrApi/public/';
        var xhr = new XMLHttpRequest();

        submitBtn.addEventListener("click", () => {
            if( testAnswers() ){
                submitForm();
            }
            else{
                successDiv.innerHTML = "Debes responder almenos una pregunta";
            }            
        })
        registerRadio.forEach( (radio) => {
            radio.addEventListener("click", () => {
                if( registerRadio[0].checked ){
                    mailDiv.style.display = "block";
                } else {
                    mailDiv.style.display = "none";
                }     
            });       
        });
        

        function submitForm(){
            fetch(postUrl, {
                method: "POST",
                body: JSON.stringify({
                    "media": getSelectedData("media"),
                    "success" : getSelectedData("success"),
                    "contents" : getSelectedData("contents"),
                    "age" : getSelectedData("age"),
                    "childs" : getSelectedData("childs"),
                    "childAge" : getSelectedData("childAge"),
                    "device" : getSelectedData("device"),
                    "register" : getSelectedData("register"),
                    "mail" : document.getElementsByName("mail")[0].value,
                }),         
            }).then(res => {
                if(res.status !== 200){
                    console.log('Looks like there was a problem. Status Code: ' + res.status);
                    successDiv.innerHTML = "Parece que hay un problema con el servidor, vuelve a intentarlo mas tarde";
                    return;
                }

                // Examine the text in the response
                // res.text().then(function (text) {
                //     console.log(text);
                // });
                res.json().then( data => {
                    console.log(data);
                });
                successDiv.innerHTML = "¡Gracias por tu valiosa respuesta a nuestra encuesta de satisfacción!";      
                submitBtn.disabled = true;          
            }).catch((err) => {
                console.log('Fetch Error :-S: ', err);
                successDiv.innerHTML = "Parece que hay un problema con el servidor, vuelve a intentarlo mas tarde";
            });
        }
            function getSelectedData(field){
                let fieldData = '';

                //iterate array options
                (document.getElementsByName(field)).forEach( (element) => {
                    if(element.checked){
                        fieldData += element.value+'/';
                    }
                });

                return fieldData;
            }
            function testAnswers(){
                let isAnswerOk = false;
                let arrayFields = ["media", "success", "contents", "age", "childs", "childAge", "device", "register"];
                
                arrayFields.forEach( elm => {
                    if( getSelectedData(elm) !== ""){
                        isAnswerOk = true;
                        return isAnswerOk
                    }    
                });

                return isAnswerOk;
            }

    </script>

</html>